<h2>Today's Fuel Report</h2>
<table id="todayReport" border="1" style="width:100%; border-collapse:collapse;">
  <thead>
    <tr>
      <th>Driver</th>
      <th>Vehicle</th>
      <th>Amount (R)</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<p id="totalToday"></p>

<script type="module">
async function loadTodaysReport() {
  const today = new Date();
  today.setHours(0,0,0,0); // start of today
  const vouchersSnap = await getDocs(collection(db, "fuel_vouchers"));
  let total = 0;
  const driverCount = {}; // count tokens per driver

  const tbody = document.querySelector("#todayReport tbody");
  tbody.innerHTML = "";

  vouchersSnap.forEach(doc => {
    const v = doc.data();
    const vDate = v.date.toDate();
    if (vDate >= today) {
      total += v.amountRand;
      driverCount[v.driverId] = (driverCount[v.driverId] || 0) + 1;

      const row = document.createElement("tr");
      const status = v.amountRand > 1000 ? "⚠️ High" :
                     driverCount[v.driverId] > 1 ? "⚠️ 2nd token" : "OK";

      row.innerHTML = `
        <td>${v.driverId}</td>
        <td>${v.vehicleId}</td>
        <td>${v.amountRand}</td>
        <td>${status}</td>
      `;
      tbody.appendChild(row);
    }
  });

  document.getElementById("totalToday").innerText = `Total fuel issued today: R${total}`;
}

// Call this after page loads
loadTodaysReport();
</script>
