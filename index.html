<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pakisa Fuel Voucher</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; background: #f5f6f8; }
    h1 { color: #072760; }
    select, input, button { width:100%; padding:8px; margin-top:5px; }
    button { background:#0F99DA; color:white; border:none; cursor:pointer; margin-top:15px; }
    button:hover { background:#072760; }
    #status { margin-top:15px; font-weight:bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #072760; color: white; }
  </style>
</head>
<body>
  <h1>Pakisa Fuel Voucher</h1>

  <form id="voucherForm">
    <label for="driver">Driver:</label>
    <select id="driver" required>
      <option value="">Loading drivers…</option>
    </select>

    <label for="vehicle">Vehicle:</label>
    <select id="vehicle" required>
      <option value="">Loading vehicles…</option>
    </select>

    <label for="amount">Fuel Amount (R):</label>
    <input type="number" id="amount" required min="50">

    <button type="submit">Send Voucher</button>
  </form>

  <p id="status"></p>

  <h3>Today's Vouchers</h3>
  <label for="exportRange">Export Range:</label>
  <select id="exportRange">
    <option value="today">Today</option>
    <option value="week">This Week</option>
    <option value="month">This Month</option>
  </select>

  <label for="exportType">Export Type:</label>
  <select id="exportType">
    <option value="excel">Excel</option>
    <option value="pdf">PDF</option>
  </select>

  <button id="exportBtn">Export</button>

  <table id="voucherTable">
    <thead>
      <tr>
        <th>Driver</th>
        <th>Vehicle</th>
        <th>Amount (R)</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, query, where, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "xxxx",
      appId: "xxxx"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const driverSelect = document.getElementById("driver");
    const vehicleSelect = document.getElementById("vehicle");
    const voucherTable = document.getElementById("voucherTable").querySelector("tbody");

    async function loadDriversAndVehicles() {
      const driversSnap = await getDocs(collection(db, "drivers"));
      driverSelect.innerHTML = "";
      driversSnap.forEach(doc => {
        const d = doc.data();
        const option = document.createElement("option");
        option.value = doc.id;
        option.textContent = `${d.name} (${d.phone})`;
        driverSelect.appendChild(option);
      });

      const vehiclesSnap = await getDocs(collection(db, "vehicles"));
      vehicleSelect.innerHTML = "";
      vehiclesSnap.forEach(doc => {
        const v = doc.data();
        const option = document.createElement("option");
        option.value = doc.id;
        option.textContent = v.registration || v.reg_number;
        vehicleSelect.appendChild(option);
      });
    }

    async function checkDuplicate(driverId, range) {
      const today = new Date();
      let start, end;
      if(range === "today") {
        start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        end = new Date(today.getFullYear(), today.getMonth(), today.getDate() +1);
      }
      // Add week/month if needed
      const q = query(
        collection(db, "fuel_vouchers"),
        where("driverId", "==", driverId),
        where("date", ">=", Timestamp.fromDate(start)),
        where("date", "<", Timestamp.fromDate(end))
      );
      const snap = await getDocs(q);
      return !snap.empty;
    }

    async function loadVouchers(range="today") {
      voucherTable.innerHTML = "";
      const today = new Date();
      let start, end;
      if(range==="today") {
        start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        end = new Date(today.getFullYear(), today.getMonth(), today.getDate()+1);
      } else if(range==="week") {
        const day = today.getDay();
        start = new Date(today.getFullYear(), today.getMonth(), today.getDate() - day);
        end = new Date(today.getFullYear(), today.getMonth(), today.getDate() + (7-day));
      } else if(range==="month") {
        start = new Date(today.getFullYear(), today.getMonth(), 1);
        end = new Date(today.getFullYear(), today.getMonth()+1, 1);
      }

      const q = query(collection(db, "fuel_vouchers"), where("date", ">=", Timestamp.fromDate(start)), where("date", "<", Timestamp.fromDate(end)), orderBy("date","desc"));
      const snap = await getDocs(q);
      snap.forEach(doc => {
        const v = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${v.driverId}</td><td>${v.vehicleId}</td><td>R${v.amountRand}</td><td>${v.date.toDate().toLocaleString()}</td>`;
        voucherTable.appendChild(tr);
      });
    }

    document.getElementById("voucherForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const driverId = driverSelect.value;
      const vehicleId = vehicleSelect.value;
      const amount = parseFloat(document.getElementById("amount").value);
      if(!driverId || !vehicleId || !amount) { alert("Fill all fields"); return; }
      if(amount>1000) { alert("Amount cannot exceed R1000"); return; }

      const duplicate = await checkDuplicate(driverId, "today");
      if(duplicate) { alert("Driver already has a voucher today"); return; }

      await addDoc(collection(db, "fuel_vouchers"), { driverId, vehicleId, amountRand: amount, date: Timestamp.now() });
      alert("Voucher created successfully!");
      document.getElementById("voucherForm").reset();
      loadVouchers("today");
    });

    document.getElementById("exportBtn").addEventListener("click", ()=>{
      const range = document.getElementById("exportRange").value;
      const type = document.getElementById("exportType").value;
      alert(`Exporting ${range} as ${type} (integration to be added)`);
    });

    loadDriversAndVehicles();
    loadVouchers("today");
  </script>
</body>
</html>
